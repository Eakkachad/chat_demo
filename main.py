from user_manager import UserManager
from config import GEMINI_API_KEY
import google.generativeai as genai
from datetime import datetime
import json
from typing import Dict, Any, List
from voice_input import VoiceInput  
from my_tts import TextToSpeech

# ตั้งค่า Gemini
genai.configure(api_key=GEMINI_API_KEY)

# สร้าง UserManager
user_manager = UserManager()

# Model สำหรับวิเคราะห์และตอบสนอง
behavior_model = genai.GenerativeModel('models/gemini-2.0-flash-001')
chat_model = genai.GenerativeModel('models/gemini-2.0-flash-001')

# ระบบ Text-to-Speech
tts = TextToSpeech()

# ระบบความจำระยะสั้น
short_term_memory = {}

def update_short_term_memory(user_id: str, message: str):
    """อัปเดตความจำระยะสั้น (จำได้ 5 ข้อความล่าสุด)"""
    if user_id not in short_term_memory:
        short_term_memory[user_id] = []
    short_term_memory[user_id].append(message)
    if len(short_term_memory[user_id]) > 5:
        short_term_memory[user_id].pop(0)

def check_inappropriate_language(text: str) -> bool:
    """ตรวจสอบภาษาหยาบคาย"""
    inappropriate_words = ["มึง", "กู", "เหี้ย", "ควาย", "เย็ด"]
    return any(word in text for word in inappropriate_words)



def analyze_user_behavior(user_id: str, user_input: str) -> Dict[str, Any]:
    """วิเคราะห์ความตั้งใจ สไตล์ และความสนใจของผู้ใช้"""
    
    prompt = f"""
    จงวิเคราะห์ข้อความต่อไปนี้และตอบในรูปแบบ JSON เท่านั้น:
    {{
        "intent": "ความตั้งใจหลัก",
        "style": "สไตล์การพูด",
        "interests": ["รายการหัวข้อที่ผู้ใช้สนใจ"]
    }}
    
    ตัวอย่าง:
    {{
        "intent": "สอบถามข้อมูล",
        "style": "ไม่เป็นทางการ",
        "interests": ["เทคโนโลยี", "AI"]
    }}
    
    ข้อความที่จะวิเคราะห์: "{user_input}"
    """
    
    analysis = {"intent": "general", "style": "neutral", "interests": []}
    
    try:
        response = behavior_model.generate_content(prompt)
        json_str = response.text[response.text.find('{'):response.text.rfind('}')+1]
        analysis = json.loads(json_str)
    except Exception as e:
        print(f"Error analyzing behavior: {e}")
    
    # โหลดโปรไฟล์ผู้ใช้ (แก้ไขให้โหลดก่อนอัปเดต)
    profile = user_manager.load_user_profile(user_id)
    print(f"\n=== DEBUG PROFILE BEFORE ===")
    print(profile)  # ตรวจสอบข้อมูลก่อนอัปเดต

    # อัปเดตข้อมูลให้ครบทุกฟิลด์
    if "style" in analysis:
        if "styles" not in profile:
            profile["styles"] = []
        profile["styles"].append(analysis["style"])

    if "interests" not in profile:
        profile["interests"] = []
    new_interests = [i for i in analysis.get("interests", []) 
                    if i not in profile["interests"]]
    profile["interests"].extend(new_interests)

    if "history" not in profile:
        profile["history"] = []
    profile["history"].append(user_input)

    # ตรวจสอบ metadata
    if "metadata" not in profile:
        profile["metadata"] = {}
    profile["metadata"]["last_updated"] = datetime.now().isoformat()

    print(f"\n=== DEBUG PROFILE AFTER ===")
    print(profile)  # ตรวจสอบข้อมูลหลังอัปเดต

    # บันทึกข้อมูล (แก้ไขให้ return ค่า success)
    if user_manager.save_user_profile(user_id, profile):
        print("✅ บันทึกข้อมูลสำเร็จ!")
    else:
        print("❌ บันทึกข้อมูลล้มเหลว!")

    return analysis

def generate_summary_of_previous_chats(user_id: str) -> str:
    """สรุปการสนทนาที่ผ่านมา"""
    interests = user_manager.get_user_interests(user_id)
    history = user_manager.get_conversation_history(user_id)
    
    summary = "เราเคยคุยกันเกี่ยวกับ:\n"
    summary += "\n".join([f"- {interest}" for interest in interests[:3]])
    summary += "\n\nบทสนทนาล่าสุด:\n"
    summary += "\n".join([f"{i+1}. {msg}" for i, msg in enumerate(history[-3:])])
    return summary

def generate_personalized_response(user_id: str, user_input: str) -> str:
    """สร้างคำตอบโดยคำนึงถึงประวัติผู้ใช้"""
    
    # ตรวจสอบคำถามเกี่ยวกับประวัติ
    if any(keyword in user_input for keyword in ["เคยคุยอะไร", "คุยอะไรกันไป", "จำได้ไหม"]):
        return generate_summary_of_previous_chats(user_id)
    
    # โหลดข้อมูลผู้ใช้
    profile = user_manager.load_user_profile(user_id)
    interests = list(set(profile.get("interests", [])))
    
    # แก้ไขตรงนี้: ตรวจสอบว่ามีสไตล์หรือไม่
    styles = profile.get("styles", [])
    style = styles[-1] if styles else "neutral"  # ใช้ "neutral" ถ้าไม่มีข้อมูล
    
    history = profile.get("history", [])[-5:]  # 5 ข้อความล่าสุด
    
    # สร้าง prompt
    prompt = f"""
    <instruction>
    คุณเป็นผู้ช่วยอัจฉริยะ ข้อมูลผู้ใช้:
    - สไตล์: {style}
    - ความสนใจ: {', '.join(interests) or 'ไม่มีข้อมูล'}
    - ประวัติสนทนา: {history}
    </instruciton>

    <context>
    คำแนะนำ:
    1. ใช้สไตล์ใกล้เคียงกับผู้ใช้
    2. อ้างอิงความสนใจของผู้ใช้
    3. ตอบอย่างเป็นธรรมชาติ
    4. ตอบตามscopeนี้(===== เด็กโรคมะเร็ง.pptx =====
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง
    คิดยังไง กับความตาย
    เริ่มต้นสนทนา
    แนะนำตัว 
    ชีวิตช่วงนี้เป็นยังไงบ้าง ?
    เหนื่อยไหม ?
    เล่าให้ฟังหน่อย
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    ก่อนป่วย น้องใช้ชีวิตอย่างไรบ้าง ชอบทำอะไร ไม่ชอบอะไร?
    ชอบกินไหม ? กินอะไร ?
    ชอบไปเที่ยว หรือ ชอบอยู่บ้าน ?
    ชอบกีฬาไหม ? ชนิดใด ? 
    มีอะไรในชีวิตที่อยากทำ  แต่ยังไม่ได้ทำบ้าง?
    มีอะไรที่น้องอยากทำ แต่ยังไม่ได้ทำบ้าง?
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง
    คิดยังไง กับความตาย
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    คุณหมอผู้ให้การรักษา บอกว่า น้องจะหายไหม?
    น้องเขารู้ไหม ว่ารักษาไป ก็ไม่มีทางหาย?
    ถ้าน้องรู้ว่ารักษาไป ก็ไม่มีทางหาย น้องจะอยากรับยาต่อไหม?
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง?
    คิดยังไง กับความตาย
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    ในสถานการณ์อย่างนี้ บางครอบครัวเขาไปดูดวง ลองสมุนไพร ไม่ทราบว่า แม่คิดอย่างไร?
    ถ้าเราล่วงรู้อนาคตว่า น้องจะมีอยู่ได้อีกเพียงหนึ่งเดือน น้องจะใช้เวลานี้ทำอะไร?
    ถ้าเผื่อถึงเวลาของน้องจริง ๆ อยากให้ภาพสุดท้ายเป็นอย่างไร?
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง?
    คิดยังไง กับความตาย?
    Contact อ.อิศรางค์ ได้โดยตรงที่…
    080-443-8080
    081-641-4797
    issarangn@yahoo.com

    ===== มะเร็งลุกลาม.pptx =====
    เมื่อมะเร็งลุกลาม:
    ทางเลือกสำหรับผู้ป่วยและครอบครัว
    ศ.ดร.นพ. อิศรางค์ นุชประยูร
    คณะแพทยศาสตร์​ จุฬาลงกรณ์มหาวิทยาลัย
    Thai Cancerr Society
    และ เยือนเย็น วิสาหกิจเพื่อสังคม
    คุณหมอ ฉันจะมีเวลาอีกเท่าไร?
    ที่ถามคำถามนี้ มีแผนอะไรอยู่ในใจหรือเปล่า ?

    ถ้ารู้อนาคตว่า มีเวลาอีกเพียงเดือนเดียว จะใช้ชีวิตอย่างไร?
    คนไข้อยากหยุด 
    แต่คนรอบตัวอยากให้สู้ต่อ ทำไงดี ?
    เราพึงเคารพ การตัดสินใจของผู้ป่วย

    ถ้าต้องอยู่กับ คนที่ไม่ยอมเห็นด้วย ให้ทำ living will
    เป็นมะเร็งลุกลาม ลองกัญชา 
    สมุนไพร การแพทย์ทางเลือก ดีไหม?
    ถ้าคนไข้อยากลอง ลองเลย ชีวิตเป็นของเรา

    ถ้าคนไข้ไม่อยากใช้ อย่าลอง
    เป็นมะเร็งลุกลาม  กินอะไรได้บ้าง?
    การกินคือ คุณภาพชีวิต
    ถ้าอดกินแล้ว อยู่ได้นานขึ้นจริง 
                ก็ต้องอยู่แบบอดอยากนานขึ้น น่ะสิ !
    เรากินอะไรเข้าไป มะเร็งก็ได้ด้วย
    มะเร็งแย่งอาหารเรา ตลอดเวลา
    ถ้าคนไข้ไม่อยากกิน อย่าฝืนใจ

    ===== ครอบครัวเด็ก.docx =====
    Pediatric Palliative Care: Elephant in a Room
    เมื่อเด็กกำลังจะตาย ประเด็นใหญ่ที่ไม่มีใครกล้าพูดถึง
    อิศรางค์ นุชประยูร
    ตารางที่ 1 ตัวอย่างของคำถามในการสนทนาเพื่อวางแผนการดูแลเด็กป่วยด้วยโรคร้าย 
    ในตัวอย่างนี้ น้อง หมายถึง เด็กป่วย ในการสนทนาจริงอาจเรียกชื่อเล่นของเขา หรือสรรพนามที่แม่ใช้เรียกเด็ก ส่วนแม่ หมายถึงผู้ปกครองที่เราสนทนาด้วย ในการสนทนาจริงอาจเรียกชื่อเล่นของเขา หรือใช้สรรพนามที่เด็กใช้เรียกผู้ปกครอง
    เรียบเรียงโดย ศ.นพ. อิศรางค์ นุชประยูร

    ===== โรคมะเร็งเด็ก.pptx =====
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง
    คิดยังไง กับความตาย
    เริ่มต้นสนทนา
    แนะนำตัว 
    ชีวิตช่วงนี้เป็นยังไงบ้าง ?
    เหนื่อยไหม ?
    เล่าให้ฟังหน่อย
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    ก่อนป่วย น้องใช้ชีวิตอย่างไรบ้าง ชอบทำอะไร ไม่ชอบอะไร?
    ชอบกินไหม ? กินอะไร ?
    ชอบไปเที่ยว หรือ ชอบอยู่บ้าน ?
    ชอบกีฬาไหม ? ชนิดใด ? 
    มีอะไรในชีวิตที่อยากทำ  แต่ยังไม่ได้ทำบ้าง?
    มีอะไรที่น้องอยากทำ แต่ยังไม่ได้ทำบ้าง?
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง
    คิดยังไง กับความตาย
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    คุณหมอผู้ให้การรักษา บอกว่า น้องจะหายไหม?
    น้องเขารู้ไหม ว่ารักษาไป ก็ไม่มีทางหาย?
    ถ้าน้องรู้ว่ารักษาไป ก็ไม่มีทางหาย น้องจะอยากรับยาต่อไหม?
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง?
    คิดยังไง กับความตาย
    แนวทางการชวนสนทนา กรณีเด็กโรคมะเร็ง
    ในสถานการณ์อย่างนี้ บางครอบครัวเขาไปดูดวง ลองสมุนไพร ไม่ทราบว่า แม่คิดอย่างไร?
    ถ้าเราล่วงรู้อนาคตว่า น้องจะมีอยู่ได้อีกเพียงหนึ่งเดือน น้องจะใช้เวลานี้ทำอะไร?
    ถ้าเผื่อถึงเวลาของน้องจริง ๆ อยากให้ภาพสุดท้ายเป็นอย่างไร?
    เริ่มต้นสนทนา
    ชีวิตก่อนป่วย เป็นอย่างไร
    ประสบการณ์ในโรงพยาบาล
    คิดยังไง กับมะเร็ง?
    คิดยังไง กับความตาย?
    Contact อ.อิศรางค์ ได้โดยตรงที่…
    080-443-8080
    081-641-4797
    issarangn@yahoo.com

    ===== เยือนเย็น.docx =====
    ให้ avatar เล่าเรื่องต่อไปนี้สักเรื่องหนึ่ง 
    พอเล่าจบ ให้ถามผู้ใช้งานว่า คิดอย่างไรเกี่ยวกับเรื่องนี้
    แล้วพาทำสมุดเบาใจ
    พ่อไม่อยากไปโรงพยาบาล
    “คุณหมอครับ ปรึกษาหน่อยครับ พ่อปวดทั่วตัวเลย แต่ไม่ยอมไปโรงพยาบาล แปะกอเอี๊ยะ ทุบตัวเองแต่ไม่หายปวด”
    ป๊าอายุ 90 ปี เคยผ่าตัดลำไส้ใหญ่ออกเนื่องจากเป็นมะเร็งเมื่อสองปีก่อน มีปัญหาแทรกซ้อนลำไส้รั่ว จึงต้องผ่าตัดใส่ทวารเทียม ป๊าดูทรมานมาก จึงไม่อยากไปโรงพยาบาลอีก ใช้ชีวิตปกติที่บ้านในช่วงสองปีที่ผ่านมาจนครั้งนี้มีเริ่มอาการปวดทั่วตัวมาประมาณ 2 สัปดาห์ แต่ไม่ยอมไปโรงพยาบาล
    ทีมเยือนเย็น วิสาหกิจเพื่อสังคม จึงไปเยี่ยมป๊าที่บ้านและคุยกับลูก ๆ ทุกคน เราประเมินว่า มะเร็งลำไส้น่าจะได้กระจายไปกระดูกแล้ว ทำให้ป๊ามีอาการปวด “เมื่อไรจะตายสักที” ป๊าพูด  เราจึงเริ่มให้ยามอร์ฟีนกิน หลังจากกินยาวิเศษนี้ได้ครึ่งชั่วโมง ป๊าปวดน้อยลงมาก ลูกแซวว่า จะวางแผนยังไงตอนตาย ป๊าบอกว่า “ยังไม่ต้องรีบวางแผนหรอก ยังไม่ตาย”
    วันต่อมา ลูก ๆ ชวนป๊าเล่นไพ่ได้ ลูกหลานมาเยี่ยม ก็คุยได้อย่างมีความสุข เราจึงนัดให้ลูก ๆ มาเอายาแก้ปวดที่โรงพยาบาล โดยป๊าไม่ต้องมา ลูก ๆ ส่งรูปอากงมาให้ดูทางไลน์  เราปรับปริมาณยาเพิ่มขึ้นจนกระทั่งหายปวด บางวันออกไปเที่ยวได้
    เดือนต่อมา ป๊าเริ่มบ่นลูก ๆ และอาละวาดเป็นบางครั้ง เราจึงนัดให้ทำเอ็มอาร์ไอสมอง พบว่ามีการขาดเลือดเป็นหย่อม ๆ ทำให้อารมณ์แปรปรวน เมื่อได้คิวทำสแกนกระดูกพบว่ามะเร็งได้กระจายไปในกระดูกทั่วทั้งตัวตามที่คาด แต่เนื่องจากกินยาเต็มที่จึงไม่ปวดแล้ว แต่ไม่อยากอาหาร ต่อมาก็เริ่มไม่มีแรง นอนเป็นส่วนใหญ่
    ลูก ๆ เคารพความประสงค์ของป๊า จึงผลัดกันดูแลที่บ้าน เยือนเย็น ไปเยี่ยมที่บ้านอีกสองครั้ง เพื่อวางแผนการดูแลในช่วงที่ติดเตียง ลูกหลานมาเยี่ยมทุกสัปดาห์ และปรึกษาได้ตลอดเวลาทางไลน์และทางโทรศัพท์ จนกระทั่งป๊าเสียชีวิตอย่างสงบและอบอุ่นที่บ้าน ในเดือนต่อมา
    พ่ออยากลองกัญชา มากกว่าเคโม
    “คุณหมอ พ่อเป็นมะเร็งปอด แต่ไม่อยากให้เคโม ทำไงดีครับ?” ลูกชายโทรมาปรึกษา
        คุณพ่ออายุ 62 ปี เดิมสูบบุหรี่จัด เริ่มเป็นถุงลมโป่งพอง เหนื่อยง่าย เดินขึ้นบ้านชั้นบนไม่ค่อยไหว เพิ่งวินิจฉัยว่าเป็นมะเร็งปอด ชนิด SCLC หมอที่โรงพยาบาลบอกว่า ก้อนดูกระจายไปทั่วปอด ผ่าตัดไม่ได้ เสนอว่าให้เคมีบำบัด แต่พ่อไม่อยากได้เคโม บอกว่าตายไม่กลัว กลัวทรมานมากกว่า 
        ลูกชายคนเล็กได้ศึกษามาว่า กัญชารักษามะเร็งได้ พ่อดูจะสนใจทางเลือกนี้มากกว่า แต่ไม่กล้าบอกหมอที่รักษาอยู่ ส่วนแม่ก็อยากให้ลองกินอาหารเพื่อสุขภาพ งดบุหรี่และเหล้า งดเนื้อสัตว์ พ่อรู้สึกเซ็งชีวิตมาก
        เยือนเย็น วิสาหกิจเพื่อสังคม จึงนัดให้คุณหมออิศรางค์ ไปคุยกับครอบครัว เมื่อประเมินแล้วพบว่า มะเร็งปอดเป็นมาก ไม่สามารถรักษาหายขาดได้ด้วยเคมีบำบัด พ่ออยากลองกัญชา และครอบครัวก็หาแบบใต้ดินมาได้แล้ว ก็สนับสนุนว่าลองเลย เราจะช่วยประเมินว่าได้ผลไหม โดยการนัดทำ CT scan หรือ MRI ให้ได้
        ส่วนเรื่องกินนั้น เราได้คุยกับพ่อและแม่ว่า เราไม่รู้ว่าอาหารจะรักษามะเร็งได้หรือไม่ แต่ถึงมันจะดีจริงและทำให้มะเร็งโตช้า แต่พ่อก็ดูเหมือนว่าจะต้องอดกินของอร่อย ถ้าชีวิตจะนานขึ้นเพราะอาหาร พ่อก็จะต้องอดของอร่อยนานขึ้น แล้วนั่นจะเป็นชีวิตที่น่าอยู่สำหรับพ่อหรือเปล่า?
        แม่ฟังแล้ว ก็ตัดสินใจว่า เลิกบังคับเรื่องอาหารจะดีกว่า พ่อจึงรู้สึกโล่งใจ มีความสุขขึ้นมาทันที การสนทนาต่อมา ทำให้ค้นพบว่า พ่ออยากย้ายบ้านไปอยู่เชียงราย ซึ่งเป็นบ้านของฝ่ายแม่ เพราะอากาศดี ซื้อที่ไว้แล้ว เราจึงสนับสนุนว่า ควรย้ายไปอยู่เชียงราย ยิ่งเร็วยิ่งดี แม่กังวลเรื่องการเดินทาง เราได้ให้ความมั่นใจว่าจะสามารถช่วยให้เดินทางได้โดยไม่ต้องกลัวอันตราย และส่งต่อให้ แพทย์พยาบาลประคับประคองที่เชียงรายช่วยดูแลต่อได้อย่างดี
        เราได้ช่วยบำบัดอาการเหนื่อยของพ่อ ด้วยยากินมอร์ฟีน ควบคู่ไปกับน้ำมันกัญชาที่ลูกชายหามาให้ และได้ลองทั้งหยอดใต้ลิ้น และสวนทวาร พ่อดีใจที่ไม่ต้องไปโรงพยาบาลอีก จะได้เฮฮากับเพื่อนบ้านได้ตลอด พ่อเบื่อการรอคอยขั้นตอนต่าง ๆ ในโรงพยาบาล พร้อมทั้งเตรียมการขายบ้าน และย้ายไปอยู่เชียงราย 
        ในที่สุด พ่อก็ขึ้นเครื่องบิน ไปถึงเชียงราย “ภารกิจสำเร็จแล้ว” พ่อประกาศ พร้อมส่งรูปบรรยากาศของรีสอร์ทธรรมชาติที่พ่อไปพักอยู่ ก่อนที่จะเดินทางไปอำเภอขุนตาล ซึ่งเป็นบ้านที่เชียงรายตั้งอยู่
        พ่อแม่ใช้ชีวิตอยู่ที่นั่นเดือนหนึ่ง มีพยาบาลประคับประคองจากโรงพยาบาลชุมชนไปเยี่ยมเยียน คุณหมออิศรางค์ ได้มีโอกาสไปเยี่ยมพร้อมทีมโรงพยาบาลเชียงประชานุเคราะห์ครั้งหนึ่ง คุณพ่อเริ่มมีอาการมากแล้ว นอนติดเตียง แต่บอกว่า ผมพร้อมที่จะตายที่บ้านแล้ว เราได้ให้กำลังใจแก่แม่และญาติที่ช่วยกันดูแลอยู่
    พ่อเสียชีวิตที่บ้านอย่างสงบตามความตั้งใจและที่สถานที่ในฝัน แม่ได้อยู่กับญาติ ๆ ที่เชียงราย ลูก ๆ ก็ได้บินไปเยี่ยมในช่วงสุดท้ายของชีวิต ทุกคนได้ทำทุกอย่างที่ตั้งใจไว้อย่างสมบูรณ์
    แม่ไม่อยากอยู่โรงพยาบาลแล้ว
    “คุณหมอ แม่อยู่โรงพยาบาลทีไร ร้องขอกลับบ้านตลอดเวลา ไม่รู้จะทำไงดี?”
    คุณแม่อายุ 88 ปี เป็นคนไข้ติดเตียง พูดรู้เรื่องบ้าง ไม่รู้เรื่องบ้าง ใส่สายสวนปัสสาวะมา 2 ปีแล้ว มีติดเชื้อในปัสสาวะ วิ่งเข้าวิ่งออกโรงพยาบาลมาแล้ว 13 หน แต่ละครั้งเริ่มด้วยมีไข้หนาวสั่น น่ากลัวมาก พอสั่นแล้วก็วัดความดันเลือดไม่ได้ ก็เลยต้องเข้าไอซียู ฉีดยาปฏิชีวนะ ใส่ท่อให้อาหาร สายน้ำเกลือ สายปัสสาวะ พอแม่ดึงออกก็มัดมือ แม่ร้องขอกลับบ้านตลอด พอออกจากไอซียู อยู่ห้องธรรมดา ก็ติดเชื้อ กว่าจะได้กลับบ้านแต่ละรอบก็สองสามอาทิตย์ เส้นแตกเป็นจ้ำ
    อยู่บ้านได้สักเดือนก็ติดเชื้ออีก หนาวสั่น ความดันต่ำ เข้าไอซียูอีก เข้า ๆ ออกมาได้ 13 รอบแล้วค่ะ สงสารแม่มาก จะไม่ไปก็ไม่ได้ ตอนที่หนาวสั่นก็ดูน่ากลัว อยู่โรงพยาบาลก็น่าสงสาร เดือนที่แล้วเพิ่งทราบว่า แม่เป็นมะเร็งที่ตับอ่อน แต่ตัดสินใจกันว่า จะไม่รักษาเพราะคงทนพิษเคโมไม่ได้แน่ ตอนนี้ ร้องปวดอยู่เรื่อย ๆ ไม่รู้ว่าปวดจริงหรือปวดเล่น เพราะว่าให้กินน้ำหวานก็หาย
    เมื่อทีมเยือนเย็น วิสาหกิจเพื่อสังคม เข้าเยี่ยมคุณแม่ครั้งแรกที่บ้าน คุณแม่ดูสบายตัว แต่ร้องปวดเป็นระยะ ๆ ทักทายกันได้ มีพี่เลี้ยงช่วยดูแลหนึ่งคน กินข้าวได้บ้างแต่กินน้อย ต้องสวนปัสสาวะวันละ 3 ครั้ง เพราะฉี่เองไม่ได้ คุณแม่เคยเป็นมะเร็งลำไส้ใหญ่ มีทวารเทียมที่หน้าท้องมานาน 28 ปีแล้ว ครอบครัวได้มอร์ฟีนมาจากคุณหมอที่โรงพยาบาลแต่ไม่กล้าให้กิน เพราะว่ากลัวจะติด 
    เราได้ใช้เวลาอธิบายครอบครัวเป็นเวลานานเพื่อให้เข้าใจตรงกันว่า ในผู้ป่วยที่ปวดอยู่นั้น การกินมอร์ฟีนจะไม่เกิดภาวะติดยา แต่จะทำให้หายปวด มีคุณภาพชีวิตดี เราควรให้มอร์ฟีนมากพอจนหายปวด ไม่ต้องทนทรมานแม้เพียงเล็กน้อย ครอบครัวจึงเริ่มให้ยามอร์ฟีน พร้อมกับยาระบาย เพื่อให้ถ่ายคล่อง และวันต่อมาแม่ก็เลิกบ่นปวด หลับได้ตื่นได้เป็นปกติ 
    เราได้ชวนทำการประชุมครอบครัวกับลูก ๆ ทุกคน เกี่ยวกับแผนการดูแล หากว่าแม่มีติดเชื้อทางปัสสาวะอีก เราอาจเลือกดูแลที่บ้าน โดยการให้ยาปฏิชีวนะกินที่บ้านทันทีที่เริ่มมีอาการเหมือนติดเชื้อปัสสาวะ โดยแทนที่จะหามแม่ขึ้นรถพยาบาล ไปโรงพยาบาลประจำ ให้รีบแจ้งเยือนเย็น เราจะมาดูที่บ้าน เก็บปัสสาวะไปตรวจและให้ยากินทันที หากว่ายาได้ผล แม่ก็จะหายไข้อย่างรวดเร็ว ไม่ต้องทรมานจากการฉีดยา ให้น้ำเกลือ ไม่ต้องเดินทางอีก ไม่ต้องอยู่โดดเดี่ยวในไอซียูซึ่งญาติเฝ้าไม่ได้ แต่ถ้าหากยากินไม่ได้ผลก็แสดงว่า รักษายาก อาจเปลี่ยนใจไปโรงพยาบาล หรือไม่ไปและ อนุญาตให้หมดเวลาตามธรรมชาติที่บ้านได้ ลูก ๆ ผู้ใกล้ชิดเห็นด้วยว่าน่าจะเป็นทางเลือกที่ดีกว่า และแม่ต้องการแบบนั้น 
    แต่ลูก 5 คนไม่ได้เห็นด้วยกับแผนการดูแลนี้ ลูกคนหนึ่งกล่าวท้วงว่า “เธอจะปล่อยให้แม่ตายที่บ้านเหรอ ?” การประชุมครอบครัวจึงยังสรุปไม่ได้ว่าจะเอาไงดี ปลายสัปดาห์นั้นเอง แม่ก็เริ่มหนาวสั่น ความดันวัดไม่ได้ ปัสสาวะขุ่น ลูกที่ใกล้ชิดแม่ได้ตัดสินใจแจ้งเยือนเย็น เราจึงให้เริ่มกินยาลดไข้ พร้อมยาปฏิชีวนะในทันทีที่บ้าน เก็บปัสสาวะไปตรวจ และเฝ้าดูอาการใกล้ชิด สองชั่วโมงต่อมาแม่หายหนาวสั่น ไข้ลง ความดันเลือดต่ำ แต่แม่นอนสบาย หัวใจเต้นช้า เราจึงเลือกเฝ้าดูอาการต่อไปที่บ้าน ลูกคนที่คัดค้านยังยุ่งอยู่กับงาน ไม่สามารถลามาพาแม่ไปโรงพยาบาลได้ เมื่อเวลาผ่านไปหนึ่งวัน แม่ก็ยังนอนสบายดีอยู่ ไม่มีไข้ ความดันเริ่มกลับเป็นปกติได้ ผลการตรวจพบการติดเชื้อในปัสสาวะจริง แต่การรักษาก็สำเร็จด้วยดียากินทีบ้าน
    แม่สบายตัวกว่าไปโรงพยาบาลมาก หายเร็วกว่า ค่าใช้จ่ายถูกกว่า ลูก ๆ ชีวิตลำบากน้อยกว่าที่จะผลัดกันไปเฝ้าที่โรงพยาบาล ทุกคนเริ่มมั่นใจว่า การดูแลที่บ้านเป็นทางเลือกที่ดี เดือนต่อมา แม่มีอาการหนาวสั่นอีก ลูกแจ้งเยือนเย็น เราเริ่มให้ยาแก้ไข้ และยาปฏิชีวนะกินทันที ไข้ลงอย่างรวดเร็วหายสั่นใน 2 ชั่วโมง แม่นอนหลับสบายแต่ความดันต่ำ หัวใจเต้นช้า ทุกอย่างสงบ หายติดเชื้ออย่างรวดเร็วอีกครั้งหนึ่ง
    เวลาดำเนินไป 4 เดือน แม่มีติดเชื้อปัสสาวะอีก 4 ครั้ง จัดการได้ยาการให้ยาที่บ้าน ต่อมาแม่เริ่มนอนหลับมากขึ้น ปลุกไม่ค่อยตื่น เหมือนสังขารใกล้จะดับ แม่ดูสบาย เราได้ลองเจาะตรวจเลือดที่บ้าน ส่งไปตรวจที่โรงพยาบาลเพื่อหาสาเหตุที่อาจแก้ไขได้ เช่น สมดุลเกลือแร่ น้ำตาล การทำงานของตับและไต แต่ก็ไม่พบเหตุ สรุปว่าสมองน่าจะเสื่อมลงตามอายุ เราได้ประเมินว่าแม่อาจจะใกล้หมดเวลา  ลูก ๆ รับได้หากว่าแม่จะจากไปอย่างสงบเช่นนี้ แต่แล้วแม่ก็ตื่นขึ้นมาเอง เล่าว่า แม่ไปเที่ยวมา นึกว่าจะตายซะแล้ว
    สองสัปดาห์ต่อมา แม่เริ่มกินน้อยลง นอนหลับมากขึ้นอีก ปลุกไม่ค่อยตื่น หายใจแผ่วลง ไม่มีอาการติดเชื้อ หลังจากนั้นไม่กินอีกเลย อาการสงบ และจากไปอย่างสบายที่บ้าน 
    การเดินทางของผู้เข้าใจสัจจธรรม
    แม่ชีเจี๊ยบบวชมากว่า 30 ปีแล้ว ได้ทำการภาวนา และสอนการปฏิบัติธรรมให้แก่ญาติโยม เป็นเวลานาน อยู่มาวันหนึ่งแม่ชีเริ่มมีอาการคลื่นใส้อาเจียนไม่ยอมหาย จึงไปตรวจที่โรงพยาบาล พบว่าเป็นมะเร็งกระเพาะอาหาร มะเร็งนั้นเป็นมากแล้ว ไม่สามารถผ่าตัดได้ และก้อนกำลังจะทำให้ทางเดินอาหารอุดตัน คุณหมอจึงแนะนำให้ใส่ท่อให้อาหารทางจมูกลึกถึงลำไส้เล็ก เพื่อที่จะได้ให้ยาและอาหารได้ 
    แม่ชียอมรับข่าวร้ายได้ด้วยจิตมั่นคง ยอมให้ใส่ท่อทางจมูก แต่หลังจากนั้นขอไม่รักษาต่อ เพราะว่าถึงจะให้ยาเคมีบำบัด หรือฉายรังสี ก็ไม่หายอยู่ดี จึงขออยู่ที่สำนักชีในวัด และปฏิบัติธรรมต่อไป แม่ชีมองว่าความตายเป็นเรื่องธรรมดา เมื่อใส่ท่ออาหารแล้วอาการอาเจียนก็หายไป สามารถปฏิบัติภาวนาต่อได้ ตั้งใจว่าจะไม่มาที่โรงพยาบาลอีก ที่สำนักชี มีสหายธรรมช่วยปรณิบัติ และมีกัลยาณมิตรอยู่มาก
    แม่ชีปรับตัวเข้ากับชีวิตใหม่ที่ต้องพึ่งอาหารเหลวผ่านสายยางทางจมูก และไม่สามารถกินทางปากได้อีก และใช้เวลาในการปฏิบัติภาวนาได้อย่างดี เวลาผ่านไปสองเดือน แม่ชีเริ่มมีอาการปวดท้อง อาเจียนอีก เริ่มภาวนาไม่ได้ ญาติธรรมและกัลยนมิตรท่านหนึ่งจึงได้ติดต่อ เยือนเย็น วิสาหกิจเพื่อสังคม ให้รู้จักและเข้ามาดูแลท่าน
    เราได้ประเมินแล้วพบว่า มะเร็งน่าจะลุกลามไปจนเกิดอาหารปวด จึงได้เสนอให้ท่านใช้มอร์ฟีน ทีแรกแม่ชีท่านปฏิเสธด้วยกลัวว่าจะทำให้จิตไม่ผ่องใส และขัดขวางการปฏิบัติภาวนา แต่เมื่อเราได้อธิบายว่า มอร์ฟีนจะช่วยกำจัดทุกขเวทนาจากความปวด และทำให้สามารถปฏิบัติภาวนาได้อีกครั้งหนึ่ง มอร์ฟีนเป็นยาที่ถูกและดี ควรใช้ให้เต็มที่ แม่ชีจึงยอมลองใช้ และปรากฏว่าหายปวดสามารถเข้าถึงการภาวนาได้ต่อเนื่อง 
    แม่ชีไม่เดือดร้อนนักเกี่ยวกับการอาเจียน เพราะเมื่ออาเจียนแล้วจะรู้สึกสบายท้อง เราจึงสนับสนุนให้กินได้ เพื่อให้มีคุณภาพชีวิตที่ดี แล้วอาเจียนออกมา แต่การให้อาหารทำให้ท้องป่องอึดอัด ก้อนอาจโตขึ้นอีกทำให้ ลำไส้อุดตัน เราจึงเปลี่ยนแผนให้งดอาหารเหลวทางท่อ แต่เปิดท่อให้ของให้กระเพาะลำไส้ไหลออกมาได้ แม่ชีจึงหายอึดอัด แต่ก็ไม่สามารถให้อาหารได้อีก เมื่อพิจารณาว่าเป็นธรรมชาติแห่งสังขาร ก็ไม่จำเป็นต้องให้อาหารอีกต่อไป แม่ชีพร้อมที่จะให้ทุกอย่างดำเนินไปตามธรรมชาติ จนเสียชีวิตที่วัด โดยไม่พึ่งโรงพยาบาล
    แม่ชีสามารถอยู่ที่วัด และภาวนาต่อไปได้อย่างมีความสุข ยิ้มสดใสเสมอ แม้ว่าร่างกายจะซูบผอมลงอย่างรวดเร็ว เพราะก้อนมะเร็งแย่งอาหารตลอดเวลา และไม่ได้กินเลย บางครั้งก้อนก็ทำให้เลือดออก แต่การให้ยามอร์ฟีนชนิดแผ่นแปะผิวหนัง ก็ทำให้ไม่เจ็บปวด เราได้เพิ่มปริมาณแผ่นแปะขึ้นเรื่อย ๆ เพื่อบำบัดปวดอย่างเต็มที่ และให้ยาอื่นเพื่อบำบัดอาการรบกวนในระหว่าง “การเดินทาง” แม่ชีอ่อนเพลียลงตามเวลา หลับมากขึ้น ตื่นน้อยลง กัลยาณมิตรได้ทยอยมาเยี่ยมแม่ชีในช่วงสุดท้าย มีแม่ชีสหายธรรมคอยกล่าวนำทางแห่งมรณสติ จนกระทั่งแม่ชีหมดลมอย่างสงบที่วัด ตามความตั้งใจของทุกฝ่าย
    แม่ชีได้แจ้งความจำนงบริจาคดวงตา และร่างกายเพื่อเป็นอาจารย์ใหญ่ แต่เนื่องจากมะเร็งทำให้ผอมมากจนผิดรูป ไม่สามารถจัดการได้ จึงได้จัดการบำเพ็ญกุศลตามประเพณี และเรื่องราวของแม่ชี ก็เป็นตัวอย่างแก่ผู้ปฏิบัติธรรม ว่าความตายนั้นไม่น่ากลัว และวงการแพทย์ช่วยบำบัดความน่าทรมานได้
    คุณหมอ หนูอยากตาย ช่วยหนูด้วย
    นั่นเป็นข้อความที่ส่งมาในไลน์จากคุณเนี้ยว เราได้รู้จักกันผ่านกลุ่มไลน์​ “เพื่อนมะเร็งไทย” เมื่อต้นปี คุณเนี้ยวเล่าชีวิตอย่างตัวเองด้วยความภาคภูมิใจว่า เธอเป็นมะเร็งเต้านมระยะที่ 4 ได้รับการรักษามาหลายครั้ง ทั้งการให้เคมีบำบัด ผ่าตัด​ ฉายรังสี โดยเริ่มเป็นตั้งแต่เมื่อ 7 ปีก่อน หลังจากโรคมะเร็งหายไป ก็ได้ช่วยงาน ชมรมมะเร็งเต้านม ไปพบปะกับผู้ป่วยมะเร็งคนอื่น ๆ ให้กำลังใจเพื่อให้ทุกคนที่กำลังรับการรักษา ให้ผ่านช่วงเวลาอันน่าโหดร้ายไปได้
    มะเร็งกลับมาหาคุณเนี้ยวหลายรอบ คุณเนี้ยวรับเคมีบำบัดครั้งแล้วครั้งเล่า มะเร็งลามไปกระดูกตรงนั้นตรงนี้ การฉายรังสีทำให้หายปวดไปได้ ให้ยาเสร็จคุณเนี้ยวก็แต่งตัวสวย และไปทำกิจกรรมกับชมรม และเชียร์ให้ผู้ป่วยมะเร็งเต้านม “สู้ ๆ” คุณเนี้ยวจึงเป็นไอดอล ของใครหลาย ๆ คน เพราะว่าขนาดเป็นระยะที่สี่ ยังมาให้กำลังใจพวกเขาได้เลย 
    ภายใต้ความสดใสและพลังอันเต็มเปี่ยมของคุณเนี้ยว เธอต้องต่อสู้กับภาวะซึมเศร้า กินยาหลายชนิด เธอไม่ยอมเล่ารายละเอียดความเจ็บป่วยให้ที่บ้านรู้ เพราะพี่สาวไม่เห็นด้วยกับวิธีใช้ชีวิตของเธอ ไม่มีใครรู้รายละเอียดว่าเธอได้ผ่านการรักษาอะไรมาบ้าง 
    หลังจากผ่านไป 7 ปี วันหนึ่งมะเร็งก็กระจายมาในสมอง คุณเนี้ยวเริ่มเดินไปถนัด หมดแรง ญาติจึงพาเข้าโรงพยาบาลอีกครั้งหนึ่ง เมื่อทราบข่าวร้ายว่ามะเร็งมาในสมองแล้ว ญาติก็ขอให้หมอช่วยผ่าตัด และฉายรังสี ถึงคุณเนี้ยวจะไม่อยากทำก็ไม่มีแรงคัดค้าน คุณเนี้ยวจึงอยู่โรงพยาบาลนานกว่าจะฟื้นตัว
    เพื่อนทราบข่าวก็เข้ามาเชียร์คุณเนี้ยวให้ “สู้ ๆ” ต่อไป แต่ตอนนี้คุณเนี้ยวเริ่มเปลี่ยนใจแล้ว “เนี้ยวเหนื่อยแล้วค่ะคุณหมอ แต่ผู้คนก็ไม่ยอมให้เนี้ยวหยุด” คุณเนี้ยวอธิบายไปร้องไห้ไป “คุณหมอช่วยเร่งให้หนูตายไว ๆ ได้ไหม หนูไม่อยากอยู่แล้ว” มะเร็งที่กลับมาในสมองอีกครั้งหนึ่งทั้งที่เพิ่งฉายรังสีครบไปเมื่อสามเดือนก่อนนั้น ทำให้คุณเนี้ยว ไม่สามารถเดินได้อีก คุณเนี้ยวถูกส่งมาอยู่เนิร์สซิ่งโฮมที่มีแต่คนแก่ เพราะที่บ้านไม่สะดวกดูแล คุณเนี้ยวเห็นอะไรหลายอย่าง ที่คนดูแลทำกับคนแก่ในที่นั้น ทำให้เธอไม่สบายใจ
    เราได้เขามาเยี่ยมคุณเนี้ยวพร้อมอาสาสมัครที่รู้จักกัน “เรามีจะให้ยาที่ช่วยคุณเนี้ยวได้ แต่เราไม่สามารถเร่งให้คุณเนี้ยวตายในทันทีได้ ต้องทำแบบเนียน ๆ ยานี้จะช่วยได้แต่ไม่ออกฤทธิเร็วนักนะ” เราสนทนากับคุณเนี้ยวเป็นเวลานาน เพื่อค้นหาว่าอะไรจะทำให้คุณเนี้ยวมีความสุขได้บ้าง อาสาสมัครได้เอาวิทยุมาให้ฟังเพลง และเราก็คุยกับพี่สาวและญาติเพื่อหาทางย้ายไปสถานที่ดูแลที่โอเคว่าที่อยู่เดิม และไม่ต้องพยายามพาไปรับการรักษาเพื่อยืดชีวิตอีก
    คุณเนี้ยวย้ายไปอยู่โรงพยาบาลที่เข้าใจสถานการณ์ เลือกไม่รับการรักษาใด ๆ ที่จะยืดชีวิตอีก งดโซเชียลมีเดีย ที่เต็มไปด้วยผู้คนที่จะเชียร์ให้สู้ ๆ โดยไม่ฟังเรื่องราวของคุณเนี้ยว คุณเนี้ยวอยู่ในความสงบ กินยาต้านซึมเศร้าและไม่ได้พูดถึงเรื่องอยากตายอีกเลย คุณเนี้ยวจากไปอย่างสงบในสองสัปดาห์ต่อมา
    หมอบอกว่า หนูรักษาไม่ได้แล้ว
    อ้อย อายุ 27 ปีเป็นมะเร็งเต้านมระยะลุกลาม เธอเล่าเรื่องชีวิตให้กับไลน์กลุ่มเพื่อนมะเร็งฟังว่า พบว่าเป็นก้อนในเต้านมตั้งแต่ตอนตั้งครรภ์ลูกสาว เมื่อคลอดลูกแล้ว จึงได้รับยาเคมีบำบัด แต่ทรมานกับผลข้างเคียงมาก ทนไม่ไหวจึงหนีไป ให้ยาไม่ครบ แต่ไปกินสมุนไพรและเลี้ยงลูกอยู่ที่บ้าน
    ตอนนี้ลูกสาวอายุ 2 ขวบแล้ว ก้อนได้กลับมาใหม่ และเริ่มเป็นแผลมาหลายเดือน แต่ไม่กล้าไปหาหมออีก เจ็บปวดทรมานมาก เราจึงไปเยี่ยมที่บ้านแถวสนามบินน้ำ คุณอ้อยอยู่กับแม่และลูกสาวในบ้านเล็ก ๆ เป็นชุมชนแออัดกลางซอย คุณอ้อยนอนตลอดเวลา ขยับแล้วปวดมาก ผอมกินอะไรไม่ค่อยได้ ที่เต้านมเป็นแผล และที่บ้านยากจนมาก
    เราประเมินว่ามะเร็งน่าจะเป็นมาก กระจายไปที่กระดูกแล้ว จึงเริ่มให้กินยาแก้ปวด และแนะนำว่าอย่างน้อยควรไปปรึกษาหมออีกครั้งเพื่อทำการฉายรังสีเพื่อทำให้แผลแห้งหรือยุบลง หลังจากกินยาแล้วเริ่มหายปวด จึงยอมไปปรึกษาหมอด้านมะเร็ง คุณหมอแนะนำให้ยาเคมีบำบัด แม้จะกลัวก็ยอมให้ยาอีกรอบหนึ่ง ก้อนยุบลง ตามด้วยการฉายรังสี แผลจึงแห้งลง คุณภาพชีวิตดีขึ้นมาก อาการปวดหายไปจึงหยุดยาแก้ปวดได้ระยะหนึ่ง
    แต่ในที่สุดมะเร็งก็ดื้อยา และกระจายไปที่สมอง คุณอ้อยเริ่มไม่แรง เดินทางไม่ได้ แม่จึงแจ้งข่าว เยือนเย็น วิสาหกิจเพื่อสังคมเข้าไปช่วยดูแล คุณอ้อยเริ่มพูดไม่รู้เรื่องแล้ว แม่เข้าใจสถานการณ์ดี ยอมรับได้ว่าโรคเป็นมากเกินกว่าที่จะยืดเวลาได้อีก พร้อมที่จะดูแลที่บ้านจนเสียชีวิต เราจึงให้คำแนะนำและวางแผนการดูแลที่บ้าน และเป็นที่ปรึกษาแก่ครอบครัวได้ตลอดเวลา แม้บ้านจะเล็กแต่ก็อบอุ่น คุณอ้อยนอนสงบโดยมีลูกสาววิ่งเล่นอยู่ข้าง ๆ มีแม่คอยดูแล และเพื่อนบ้านมาเยี่ยม คุณอ้อยหลับไป ปลุกไม่ตื่น และเสียชีวิตอย่างสงบและอบอุ่นในอีกสามสัปดาห์ถัดมา
    พาพ่อกลับบ้าน
        ปะป๊าอายุ 91 ปี หลังจากที่ได้รับการวินิจฉัยว่าเป็นลูคีเมีย ชนิด AML เลือกไม่รับเคมีบำบัด รักษาด้วยการให้เลือดและเกล็ดเลือดทุก 3 สัปดาห์ ดูแลที่บ้านเป็นส่วนใหญ่ อาการสบายดี กินได้ เดินได้ ทุกคนรู้ว่าไม่หายแน่นอน ปะป๊าบอกว่าถ้าเป็นอะไรไปไม่ให้ใส่ท่อช่วยหายใจ หรือท่ออะไรทั้งสิ้น ครอบครัวเห็นด้วย เมื่อเวลาผ่านไป 4 เดือน ปะป๊าป่วยเป็นไข้สูง หอบเหนื่อย หมดสติ จึงหามเข้าโรงพยาบาล หมอตรวจแล้วแจ้งว่าหายใจไม่เพียงพอ คงต้องใช้เครื่องช่วยหายใจ ลูก ๆ ตกใจจึงตอบตกลงให้หมอช่วยเต็มที่ ใส่ท่อและเครื่องช่วยหายใจ เข้าไอซียู ให้ยาปฏิชีวนะ ในที่สุดอาการดีขึ้น ปะป๊าตื่นขึ้นมาพบว่าใส่ท่อช่วยหายใจอยู่ จึงโกรธมากจะถอดท่อออก พยาบาลจึงต้องผูกมือไว้ ลูก ๆ รู้สึกสงสารและรู้สึกผิดที่ไม่ได้ปฏิบัติตามที่ปะป๊าสั่งไว้ ในที่สุดเมื่ออาการทางปอดฟื้นตัวมากพอ ก็ถอดท่อได้สำเร็จ ปะป๊าขอให้พากลับบ้าน แต่หมอพบว่าปอดติดเชื้อที่รักษายาก ต้องให้ยาเป็นเวลา 4 สัปดาห์ ลูกจึงต้องหาวิธีอธิบายว่าทำไมจึงยังกลับบ้านไม่ได้ ประวิงเวลาไว้ก่อน
        เมื่อให้ยาครบ 4 สัปดาห์ ยังไม่ทันได้กลับบ้าน ปะป๊าก็มีไข้สูงขึ้นมาอีก หมอจึงหาสาเหตุพบว่า ติดเชื้อวัณโรคและเชื้อรา จึงต้องเริ่มให้ยารักษาวัณโรคและเชื้อรา อาการทางปอดเริ่มมากขึ้นอีก จนถึงขั้นที่หมอบอกว่า คงจะต้องใช้เครื่องช่วยหายใจอีก แต่คราวนี้ลูก ๆ ปฏิเสธไม่ยอมให้ใส่เครื่อง ปะป๊าเริ่มหอบเหนื่อย ลูก ๆ จึงต้องหาทางเอาปะป๊ากลับบ้านตามสัญญา แม้ว่าจะต้องเสียชีวิตที่บ้านก็ยังดี แต่จะทำอย่างไร?
        ลูก ๆ ถามเพื่อนที่เป็นหมอ ทุกคนฟังเรื่องราวแล้วบอกว่าไม่น่าจะเป็นไปได้ เพื่อนคนหนึ่งจึงติดต่อเยือนเย็น วิสาหกิจเพื่อสังคม เราจึงได้นัดคุยกันด่วนเพื่อวางแผนพาปะป๊ากลับบ้าน โดยไม่ต้องใช้เครื่องช่วยหายใจ เมื่อคุยกับลูกสาวทั้งสี่คนแล้ว ทุกคนเห็นด้วยว่าควรย้ายกลับบ้านด่วน โดยเตรียมการจัดหาถังออกซิเจนจำนวนมากมาสต้อคไว้ที่บ้าน เพราะต้องใช้ถึง 15 ลิตรต่อชั่วโมง จัดหาผู้ดูแล และเตรียมยาไว้พร้อม แล้วรีบจัดรถพยาบาลส่งตัวปะป๊ากลับบ้านอย่างรวดเร็ว บ้านจึงกลายเป็นไอซียูที่สวยที่สุด มองเห็นสวนหน้าบ้านได้ 
        เราได้วางแผนกันว่า เมื่อปะป๊ามาถึงบ้าน เราจะสามารถบำบัดให้ปะป๊าหายเหนื่อยได้ โดยการให้มอร์ฟีนทางสายยางเข้ากระเพาะ ซึ่งใส่มาตลอดเดือน แต่เมื่อเริ่มให้ยาแล้ว ปะป๊าอาจจะหายใจสบาย จนหลับไป ไม่คุยกับใครอีก ทางบ้านแจ้งว่ามีหลานสาวที่ปะป๊ารักมาก เรียนอยู่ฮ่องกงใกล้จบแล้ว จะยืดเวลาปะป๊าถึงสองสัปดาห์ได้ไหม เราบอกว่าไม่ได้ ถ้าจะมาเยี่ยมต้องมาในทันทีเลย ครอบครัวจึงติดต่อด่วนและให้หลานสาวบินกลับมาทันที 
        เมื่อหลานรักได้มาเยี่ยมคุณตาเป็นครั้งสุดท้าย และร่ำลากันเรียบร้อย เราจึงเริ่มให้มอร์ฟีน แม้จะเริ่มเพียงปริมาณเล็กน้อย ปะป๊าก็หายหอบ หายใจสบายขึ้น หลับได้และไม่ตื่นอีกเลย ครอบครัวแจ้งให้ญาติทยอยกันมาเยี่ยมที่บ้าน ในบรรยากาศที่กว้างขวาง สะอาด สว่าง สงบ ไม่มีเสียงรบกวน สัญญาณชีพเริ่มลดลงอย่างช้า ๆ และดับไปอย่างสงบ ประมาณ 48 ชั่วโมงหลังจากกลับมาถึงบ้าน)ถ้าเกินกว่านี้ให้ติดต่อตามช่องทางที่ให้ไปในscope
    5. อย่าตอบนอกเหนือscope
    </context>

    <reminder>
        จำว่าคำสั่งคืออะไรและทำตามคำสั่งต่อไปนี้
    </reminder>


    ข้อความจากผู้ใช้: "{user_input}"
    
    คำตอบของคุณ:
    """
    
    try:
        response = chat_model.generate_content(prompt)
        return response.text
    except Exception as e:
        print(f"Error generating response: {e}")
        return "ขอโทษครับ เกิดข้อผิดพลาดในการสร้างคำตอบ"

def show_learning_info(user_id: str):
    """แสดงข้อมูลการเรียนรู้"""
    profile = user_manager.load_user_profile(user_id)
    print("\n[ระบบเรียนรู้]:")
    print(f"สไตล์ล่าสุด: {profile['styles'][-1] if profile.get('styles') else 'ยังไม่มีข้อมูล'}")
    print(f"ความสนใจ: {', '.join(set(profile['interests'])) if profile.get('interests') else 'ยังไม่มีข้อมูล'}")
    print(f"จำนวนข้อความ: {len(profile['history']) if profile.get('history') else 0}")
    print(f"อัปเดตล่าสุด: {profile['metadata']['last_updated'] if profile.get('metadata') else 'ยังไม่มีข้อมูล'}")

def chat_loop():
    """โหมดสนทนาด้วยการพิมพ์"""
    print("สวัสดี! ผมเป็นแชทบอทที่เรียนรู้พฤติกรรมคุณได้")
    user_id = input("กรุณาระบุชื่อหรือ ID ของคุณ: ").strip()
    
    # แสดงสรุปการสนทนาก่อนหน้า (ถ้ามี)
    profile = user_manager.load_user_profile(user_id)
    if profile.get("history"):
        print(f"\nยินดีต้อนรับกลับ! เราเคยคุยกันเรื่อง: {', '.join(set(profile['interests'])) if profile.get('interests') else 'หลายเรื่อง'}")
    
    while True:
        user_input = input("คุณ: ").strip()
        if user_input.lower() in ["exit", "quit", "bye"]:
            print("ลาก่อน! มีอะไรให้ช่วยอีกไหมคะ?")
            break
            
        # ตรวจสอบภาษาหยาบคาย
        if check_inappropriate_language(user_input):
            error_msg = "ขอโทษครับ แต่ผมไม่สามารถตอบกลับภาษาที่ไม่เหมาะสมได้"
            print(error_msg)
            continue
            
        # สร้างและแสดงคำตอบ
        response = generate_personalized_response(user_id, user_input)
        print("บอท:", response)
        
        # อัปเดตความจำระยะสั้น
        update_short_term_memory(user_id, user_input)
        
        # แสดงข้อมูลการเรียนรู้
        show_learning_info(user_id)

def voice_chat_loop():
    """โหมดสนทนาด้วยเสียง"""
    global tts
    
    tts = TextToSpeech()
    print("\n=== โหมดสั่งงานด้วยเสียง ===")
    print("คำสั่งพิเศษ: 'ออก', 'หยุด', 'เปลี่ยนโหมด'")
    print("กด Enter แล้วพูดได้เลย (หรือพูด 'ออก' เพื่อจบการทำงาน)")
    
    voice_input = VoiceInput()
    user_id = input("กรุณาระบุชื่อหรือ ID ของคุณ: ").strip()
    
    # วิเคราะห์พฤติกรรมเริ่มต้น
    analyze_user_behavior(user_id, "เริ่มสนทนา")
    
    while True:
        input("กด Enter เพื่อเริ่มพูด...")
        print("กำลังฟัง...")
        
        user_input = voice_input.listen()
        if not user_input:
            print("ไม่สามารถรับเสียงได้ โปรดลองอีกครั้ง")
            continue
            
        print(f"คุณพูดว่า: {user_input}")
        
        if any(cmd in user_input for cmd in ["ออก", "หยุด", "เปลี่ยนโหมด"]):
            tts.speak("เปลี่ยนเป็นโหมดพิมพ์")
            print("เปลี่ยนเป็นโหมดพิมพ์...")
            tts = None
            break
            
        # วิเคราะห์พฤติกรรมผู้ใช้ (เรียกครั้งเดียว)
        analysis = analyze_user_behavior(user_id, user_input)
        print(f"ผลการวิเคราะห์: {analysis}")  # Debug
            
        response = generate_personalized_response(user_id, user_input)
        print("บอท:", response)
        tts.speak(response)
        
        show_learning_info(user_id)
def main_menu():
    """เมนูหลักของโปรแกรม"""
    print("\n" + "="*50)
    print("ระบบแชทบอทอัจฉริยะ".center(50))
    print("="*50)
    print("1. โหมดพิมพ์ข้อความ")
    print("2. โหมดสั่งงานด้วยเสียง")
    print("3. ออกจากระบบ")
    choice = input("เลือกโหมดการทำงาน [1-3]: ")
    return choice

if __name__ == "__main__":
    """จุดเริ่มต้นการทำงานของโปรแกรม"""
    while True:
        choice = main_menu()
        
        if choice == "1":
            chat_loop()  # โหมดพิมพ์
        elif choice == "2":
            voice_chat_loop()  # โหมดเสียง
        elif choice == "3":
            print("ปิดระบบ...")
            break
        else:
            print("กรุณาเลือก 1, 2 หรือ 3")